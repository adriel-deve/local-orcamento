<%- include('../partials/top') %>

<style>
  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: inline-block;
    background: #f59e0b;
    color: white;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 0.875rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
  }

  .btn-edit { background: #3b82f6; color: white; }
  .btn-edit:hover { background: #2563eb; }

  .btn-view { background: #6b7280; color: white; }
  .btn-view:hover { background: #4b5563; }

  .btn-delete { background: #ef4444; color: white; }
  .btn-delete:hover { background: #dc2626; }

  .quotes-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  .quotes-table th,
  .quotes-table td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .quotes-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .quotes-table tr:hover {
    background: #f9fafb;
  }
</style>

<h2 style="margin-bottom: 24px; color: #1f2937; display: flex; align-items: center; gap: 12px;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 32px; height: 32px; stroke: #f59e0b;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    <polyline points="14 2 14 8 20 8"></polyline>
    <line x1="16" y1="13" x2="8" y2="13"></line>
    <line x1="16" y1="17" x2="8" y2="17"></line>
    <polyline points="10 9 9 9 8 9"></polyline>
  </svg>
  Rascunhos de Cotações
</h2>

<!-- Stats Card -->
<div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 32px;">
  <div class="stat-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #f59e0b;">
    <h3 style="font-size: 2.5rem; font-weight: 700; margin: 0 0 8px 0; color: #f59e0b;" id="totalDisplayed"><%= quotes ? quotes.length : 0 %></h3>
    <p style="margin: 0; color: #6b7280; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">Total de Rascunhos</p>
  </div>
</div>

<% if (quotes && quotes.length > 0) { %>
<section class="card">
  <!-- Filtros e Pesquisa -->
  <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #e5e7eb;">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; align-items: end;">
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.875rem; display: flex; align-items: center; gap: 6px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          Pesquisar por Nome
        </label>
        <input
          type="text"
          id="searchInput"
          placeholder="Digite cliente, fornecedor ou código..."
          style="width: 100%; padding: 10px 14px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.875rem;"
          oninput="filterQuotes()"
        />
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.875rem; display: flex; align-items: center; gap: 6px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          Filtrar por Fornecedor
        </label>
        <select
          id="supplierFilter"
          style="width: 100%; padding: 10px 14px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; cursor: pointer;"
          onchange="filterQuotes()"
        >
          <option value="">Todos os Fornecedores</option>
          <%
            const suppliers = [...new Set(quotes.map(q => q.supplier).filter(s => s))];
            suppliers.forEach(supplier => {
          %>
            <option value="<%= supplier %>"><%= supplier %></option>
          <% }); %>
        </select>
      </div>
      <div>
        <button
          onclick="clearFilters()"
          style="width: 100%; padding: 10px 14px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; justify-content: center; gap: 6px;"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h3 style="margin: 0;">Lista de Rascunhos</h3>
    <a href="/quotes/new" class="btn primary" style="display: inline-flex; align-items: center; gap: 8px;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Nova Cotação
    </a>
  </div>

  <table class="quotes-table">
    <thead>
      <tr>
        <th>Código</th>
        <th>Cliente</th>
        <th>Fornecedor</th>
        <th>Data</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <% quotes.forEach(function(quote) { %>
      <tr data-supplier="<%= quote.supplier || '' %>">
        <td><strong style="color: #dc2626;"><%= quote.quote_code %></strong></td>
        <td><%= quote.client || quote.company || '-' %></td>
        <td><strong style="color: #6b7280;"><%= quote.supplier || '-' %></strong></td>
        <td><%= new Date(quote.date).toLocaleDateString('pt-BR') %></td>
        <td>
          <span class="status-badge">
            <%= quote.status %>
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button onclick="continueDraft('<%= quote.quote_code %>')" class="btn-small btn-edit">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Editar
            </button>
            <a href="/quotes/<%= quote.quote_code %>/layout" target="_blank" class="btn-small btn-view">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              Visualizar
            </a>
            <button onclick="deleteQuote('<%= quote.quote_code %>')" class="btn-small btn-delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Excluir
            </button>
          </div>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</section>
<% } else { %>
<section class="card" style="text-align: center; padding: 60px 20px;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 64px; height: 64px; margin: 0 auto 24px; color: #9ca3af;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    <polyline points="14 2 14 8 20 8"></polyline>
    <line x1="16" y1="13" x2="8" y2="13"></line>
    <line x1="16" y1="17" x2="8" y2="17"></line>
  </svg>
  <h3 style="margin-bottom: 12px; color: #374151;">Nenhum Rascunho Encontrado</h3>
  <p style="color: #6b7280; margin-bottom: 32px; font-size: 0.875rem;">Você não possui rascunhos salvos no momento.</p>
  <a href="/quotes/new" class="btn primary" style="display: inline-flex; align-items: center; gap: 8px;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    Criar Nova Cotação
  </a>
</section>
<% } %>

<script>
function continueDraft(quoteCode) {
  window.location.href = "/quotes/new?load_code=" + encodeURIComponent(quoteCode);
}

function deleteQuote(quoteCode) {
  if (confirm('Tem certeza que deseja excluir este rascunho? Esta ação não pode ser desfeita.')) {
    fetch(`/quotes/delete/${quoteCode}`, {
      method: 'DELETE'
    })
    .then(response => {
      if (response.ok) {
        window.location.reload();
      } else {
        alert('Erro ao excluir rascunho.');
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao excluir rascunho.');
    });
  }
}

function filterQuotes() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const supplierFilter = document.getElementById('supplierFilter').value;
  const rows = document.querySelectorAll('.quotes-table tbody tr');
  let visibleCount = 0;

  rows.forEach(row => {
    const code = row.cells[0]?.textContent.toLowerCase() || '';
    const client = row.cells[1]?.textContent.toLowerCase() || '';
    const supplier = row.getAttribute('data-supplier') || '';
    const supplierDisplay = row.cells[2]?.textContent.toLowerCase() || '';

    const matchesSearch = !searchTerm ||
      code.includes(searchTerm) ||
      client.includes(searchTerm) ||
      supplierDisplay.includes(searchTerm);

    const matchesSupplier = !supplierFilter || supplier === supplierFilter;

    if (matchesSearch && matchesSupplier) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });

  document.getElementById('totalDisplayed').textContent = visibleCount;
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('supplierFilter').value = '';
  filterQuotes();
}
</script>

<%- include('../partials/bottom') %>
