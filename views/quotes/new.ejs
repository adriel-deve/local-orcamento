<%- include('../partials/top') %>

<!-- Se√ß√£o para carregar cota√ß√£o existente -->
<section class="card" style="background: var(--gray-50); border: 2px dashed var(--gray-300);">
  <h3 style="color: var(--gray-600); margin-bottom: 1rem;">Carregar Cota√ß√£o Existente (Opcional)</h3>
  <div style="display: flex; gap: 1rem; align-items: center;">
    <select id="existing_quotes" style="flex: 1; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 1rem;">
      <option value="">Selecione uma cota√ß√£o para carregar...</option>
    </select>
    <button type="button" onclick="loadExistingQuote()" class="btn secondary" style="white-space: nowrap;">
      Carregar Dados
    </button>
  </div>
  <p style="color: var(--gray-500); font-size: 0.875rem; margin-top: 0.5rem; margin-bottom: 0;">
    Carregue uma cota√ß√£o existente para usar como base ou continuar editando.
  </p>
</section>

<section class="card">
  <h2>Nova Cota√ß√£o</h2>

  <form id="quoteForm" class="form" method="post" action="/quotes/save" enctype="multipart/form-data">
    <!-- Informa√ß√µes Principais -->
    <h3>Informa√ß√µes da Cota√ß√£o</h3>
    <div class="grid">
      <div class="field">
        <label>N√∫mero da Cota√ß√£o</label>
        <input name="quote_code" type="text" placeholder="COT-2025-0001" required />
        <small>C√≥digo √∫nico identificador da cota√ß√£o</small>
      </div>
      <div class="field">
        <label>Data da Cota√ß√£o</label>
        <input name="date" type="date" required />
        <small>Data de emiss√£o da cota√ß√£o</small>
      </div>
    </div>

    <!-- Dados do Cliente -->
    <h3>Dados do Cliente</h3>
    <div class="grid">
      <div class="field">
        <label>Nome do Cliente</label>
        <input name="client" type="text" placeholder="Nome da empresa cliente" required />
      </div>
      <div class="field">
        <label>CNPJ do Cliente</label>
        <input name="cnpj" type="text" placeholder="00.000.000/0000-00" />
        <small>CNPJ da empresa cliente (opcional)</small>
      </div>
    </div>

    <!-- Dados Internos -->
    <h3>Informa√ß√µes Comerciais</h3>
    <div class="grid">
      <div class="field">
        <label>Empresa Vendedora</label>
        <input name="company" type="text" placeholder="Nome da empresa vendedora" required />
      </div>
      <div class="field">
        <label>Representante Comercial</label>
        <input name="representative" type="text" placeholder="Nome do representante" required />
      </div>
      <div class="field">
        <label>Modelo da M√°quina</label>
        <input name="machine_model" type="text" placeholder="Modelo do equipamento" />
        <small>Modelo principal do equipamento cotado</small>
      </div>
    </div>

    <!-- Condi√ß√µes Comerciais -->
    <h3>Condi√ß√µes da Proposta</h3>
    <div class="grid">
      <div class="field">
        <label>Validade da Proposta</label>
        <input name="validity" type="number" min="1" max="365" value="15" />
        <small>Per√≠odo em dias para validade da cota√ß√£o</small>
      </div>
      <div class="field">
        <label>Prazo de Entrega</label>
        <input name="delivery" type="text" placeholder="Ex: 30 dias √∫teis ap√≥s aprova√ß√£o" />
        <small>Tempo estimado para entrega dos equipamentos</small>
      </div>
    </div>

    <!-- Se√ß√µes de Equipamentos -->
    <div id="equipment-sections-container">
      <h3>Especifica√ß√µes dos Equipamentos</h3>
      <div id="equipment-sections">
        <!-- Primeira se√ß√£o (sempre presente) -->
        <div class="equipment-section" data-section-id="0">
          <div class="equipment-section-header">
            <h4>Equipamento 1</h4>
            <button type="button" class="btn danger" onclick="removeEquipmentSection(0)" style="display: none;">Remover</button>
          </div>
          <div class="grid">
            <div class="field">
              <label>Especifica√ß√£o T√©cnica</label>
              <textarea class="tech_spec" rows="4" placeholder="Detalhe t√©cnico do equipamento..."></textarea>
            </div>
            <div class="field">
              <label>Princ√≠pio de Funcionamento</label>
              <textarea class="principle" rows="4" placeholder="Descreva o princ√≠pio de funcionamento..."></textarea>
            </div>
          </div>
          <div class="field">
            <label>Imagem do Equipamento</label>
            <input type="file" class="equipment_image" accept="image/*" />
            <small style="color: #666; font-size: 12px;">Formatos aceitos: JPG, PNG, GIF (m√°x. 5MB)</small>
          </div>
        </div>
      </div>
      <button type="button" class="btn" onclick="addEquipmentSection()">Adicionar Outro Equipamento</button>
    </div>

    <h3>Observa√ß√µes e Notas</h3>
    <div class="field">
      <label>Observa√ß√µes Gerais</label>
      <textarea name="notes" rows="4" placeholder="Observa√ß√µes importantes, condi√ß√µes especiais, detalhes t√©cnicos adicionais..."></textarea>
      <small>Informa√ß√µes complementares que ser√£o inclu√≠das na cota√ß√£o</small>
    </div>

    <hr />
    <h3>Informa√ß√µes de Contato</h3>
    <div class="grid">
      <div class="field">
        <label>Nome do Vendedor</label>
        <input name="seller_name" type="text" placeholder="Nome completo do vendedor respons√°vel" />
        <small>Vendedor respons√°vel pela proposta</small>
      </div>
      <div class="field">
        <label>Email para Contato</label>
        <input name="contact_email" type="email" placeholder="vendedor@pharmatec.com.br" />
        <small>Email principal para comunica√ß√£o</small>
      </div>
      <div class="field">
        <label>Telefone para Contato</label>
        <input name="contact_phone" type="text" placeholder="(11) 99999-9999" />
        <small>Telefone comercial para contato direto</small>
      </div>
    </div>

    <hr />
    <h3>Modalidades de Entrega</h3>

    <!-- MODALIDADE A (Sistema CIF) -->
    <div class="modalidade-container" style="border: 2px solid var(--primary); border-radius: 8px; padding: 20px; margin: 20px 0; background: rgba(220, 38, 38, 0.05);">
      <h2 style="color: var(--primary); margin-bottom: 20px;">Modalidade A (Sistema CIF)</h2>

      <h4>Itens (Equipamentos)</h4>
      <div id="sec_equip_a" class="spec">
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_equip_a')">Adicionar Equipamento</button>
      </div>

      <h4>Servi√ßos de Assessoria na Importa√ß√£o</h4>
      <div id="sec_assessoria_a" class="spec">
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_assessoria_a')">Adicionar Servi√ßo de Assessoria</button>
      </div>

      <h4>Servi√ßos Operacionais e Preventivos</h4>
      <div id="sec_operacionais_a" class="spec">
        <div class="checkboxes" style="margin-bottom:10px">
          <label><input type="checkbox" value="FAT" onchange="handleServiceToggle(this,'sec_operacionais_a')"/> FAT</label>
          <label><input type="checkbox" value="SAT" onchange="handleServiceToggle(this,'sec_operacionais_a')"/> SAT</label>
          <label><input type="checkbox" value="Startup" onchange="handleServiceToggle(this,'sec_operacionais_a')"/> Startup</label>
          <label><input type="checkbox" value="Treinamento" onchange="handleServiceToggle(this,'sec_operacionais_a')"/> Treinamento</label>
          <label><input type="checkbox" value="Acompanhamento" onchange="handleServiceToggle(this,'sec_operacionais_a')"/> Acompanhamento</label>
          <label><input type="checkbox" value="Manuten√ß√£o" onchange="handleServiceToggle(this,'sec_operacionais_a')"/> Manuten√ß√£o</label>
        </div>
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_operacionais_a')">Adicionar Servi√ßo Operacional</button>
      </div>

      <h4>Certificados</h4>
      <div id="sec_certificados_a" class="spec">
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_certificados_a')">Adicionar Certificado</button>
      </div>
    </div>

    <!-- MODALIDADE B (Sistema FOB) -->
    <div class="modalidade-container" style="border: 2px solid var(--secondary); border-radius: 8px; padding: 20px; margin: 20px 0; background: rgba(31, 41, 55, 0.05);">
      <h2 style="color: var(--secondary); margin-bottom: 20px;">Modalidade B (Sistema FOB)</h2>

      <div style="margin-bottom: 15px;">
        <button type="button" class="btn" onclick="copyModalidadeAToB()" style="background: var(--secondary);">Copiar Modalidade A para B</button>
        <button type="button" class="btn" onclick="clearModalidadeB()" style="background: #dc2626; margin-left: 10px;">Limpar Modalidade B</button>
      </div>

      <h4>Itens (Equipamentos)</h4>
      <div id="sec_equip_b" class="spec">
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_equip_b')">Adicionar Equipamento</button>
      </div>

      <h4>Servi√ßos de Assessoria na Importa√ß√£o</h4>
      <div id="sec_assessoria_b" class="spec">
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_assessoria_b')">Adicionar Servi√ßo de Assessoria</button>
      </div>

      <h4>Servi√ßos Operacionais e Preventivos</h4>
      <div id="sec_operacionais_b" class="spec">
        <div class="checkboxes" style="margin-bottom:10px">
          <label><input type="checkbox" value="FAT" onchange="handleServiceToggle(this,'sec_operacionais_b')"/> FAT</label>
          <label><input type="checkbox" value="SAT" onchange="handleServiceToggle(this,'sec_operacionais_b')"/> SAT</label>
          <label><input type="checkbox" value="Startup" onchange="handleServiceToggle(this,'sec_operacionais_b')"/> Startup</label>
          <label><input type="checkbox" value="Treinamento" onchange="handleServiceToggle(this,'sec_operacionais_b')"/> Treinamento</label>
          <label><input type="checkbox" value="Acompanhamento" onchange="handleServiceToggle(this,'sec_operacionais_b')"/> Acompanhamento</label>
          <label><input type="checkbox" value="Manuten√ß√£o" onchange="handleServiceToggle(this,'sec_operacionais_b')"/> Manuten√ß√£o</label>
        </div>
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_operacionais_b')">Adicionar Servi√ßo Operacional</button>
      </div>

      <h4>Certificados</h4>
      <div id="sec_certificados_b" class="spec">
        <div class="items"></div>
        <button type="button" class="btn" onclick="addRow('sec_certificados_b')">Adicionar Certificado</button>
      </div>
    </div>

    <input type="hidden" id="specs_json" name="specs_json" />
    <input type="hidden" id="action_field" name="action" value="save" />

    <!-- Condi√ß√µes de Pagamento -->
    <div class="payment-conditions-container" style="border: 2px solid #10b981; border-radius: 8px; padding: 20px; margin: 20px 0; background: rgba(16, 185, 129, 0.05);">
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <input type="checkbox" id="include_payment_conditions" name="include_payment_conditions" onchange="togglePaymentConditions()" />
        <label for="include_payment_conditions" style="margin-left: 8px; font-weight: bold; color: #10b981; font-size: 16px;">Incluir Condi√ß√µes de Pagamento</label>
      </div>

      <div id="payment_conditions_fields" style="display: none;">
        <h3 style="color: #10b981; margin-bottom: 20px;">Condi√ß√µes de Pagamento</h3>

        <div class="field">
          <label>Introdu√ß√£o das Condi√ß√µes</label>
          <textarea name="payment_intro" rows="2" placeholder="Texto introdut√≥rio das condi√ß√µes de pagamento...">As condi√ß√µes de pagamento e faturamento dos valores estipulados nesta proposta, ser√£o conforme abaixo:</textarea>
        </div>

        <div class="field">
          <label>Montante em D√≥lares - Condi√ß√µes</label>
          <textarea name="payment_usd_conditions" rows="3" placeholder="Condi√ß√µes para valores em d√≥lar...">01 (um) dep√≥sito no aceite da invoice referente a 50% do valor ofertado em d√≥lares e o saldo de 50% do valor em d√≥lares restante da proposta pago na chegada do pedido no porto aduaneiro.</textarea>
        </div>

        <div class="field">
          <label>Introdu√ß√£o Montante em Reais</label>
          <textarea name="payment_brl_intro" rows="2" placeholder="Texto introdut√≥rio para valores em reais...">Montante em reais brasileiros de servi√ßos prestados de acordo com a op√ß√£o:</textarea>
        </div>

        <div class="field">
          <label>Condi√ß√µes para Modalidade com SAT</label>
          <textarea name="payment_brl_with_sat" rows="6" placeholder="Condi√ß√µes de pagamento para modalidade com SAT...">Referente apenas‚Ä†‚Ä† ao montante resultante dos servi√ßos contratados do Grupo Zanatech: Pagamento parcelado em 03 (tr√™s) parcelas pagas atrav√©s de dep√≥sitos ou boletos:
1. Primeira parcela, no valor de 10% do montante em reais, para ser paga no aceite da invoice;
2. Segunda parcela no valor de 30% do montante em reais, para ser paga na chegada do pedido na empresa ou 60 dias corridos ap√≥s o aceite da invoice, o que ocorrer primeiro;
3. Terceira parcela no valor de 60% do montante em reais, para ser paga 30 dias ap√≥s aprova√ß√£o do SAT ou 90 dias corridos ap√≥s o aceite da invoice, o que ocorrer primeiro;</textarea>
        </div>

        <div class="field">
          <label>Condi√ß√µes para Modalidade sem SAT</label>
          <textarea name="payment_brl_without_sat" rows="4" placeholder="Condi√ß√µes de pagamento para modalidade sem SAT...">Referente apenas‚Ä†‚Ä† ao montante resultante dos servi√ßos contratados do Grupo Zanatech: Pagamento parcelado em 02 (duas) parcelas pagas atrav√©s de dep√≥sitos ou boletos:
1. Primeira parcela, no valor de 10% do montante em reais, para ser paga no aceite da invoice;
2. Segunda parcela no valor de 90% do montante em reais, para ser paga na chegada do pedido no porto aduaneiro;</textarea>
        </div>

        <div class="field">
          <label>Observa√ß√µes Adicionais</label>
          <textarea name="payment_additional_notes" rows="8" placeholder="Observa√ß√µes adicionais sobre condi√ß√µes de pagamento...">N√£o fazem parte dos servi√ßos prestados pelo Grupo Zanatech os itens anteriores: 1. Honor√°rios de despachantes e manuseio; 2. Despesas de Importa√ß√£o; 3. Transporte at√© a porta da empresa. Os pagamentos e condi√ß√µes de tais itens s√£o negociados diretamente entre a empresa contratante e a prestadora do servi√ßo em quest√£o. As empresas parceiras recomendadas pelo Grupo Zanatech podem oferecer condi√ß√µes e descontos especiais nas condi√ß√µes pr√©-estabelecidas. Para o start-up, o EQUIPAMENTO deve estar em √ÅREA QUALIFICADA, com f√°cil acesso √†s UTILIDADES (ar comprimido, alimenta√ß√£o el√©trica) necess√°rias, caso contr√°rio poder√° haver atrasos e custos adicionais.</textarea>
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="btn secondary" onclick="saveDraft()">
        üíæ Salvar Rascunho
      </button>
      <button type="button" class="btn primary" onclick="previewHtml()">
        Concluir Cota√ß√£o
      </button>
    </div>
  </form>
</section>

<script>
  // Equipment sections management
  let equipmentSectionCounter = 0;

  function addEquipmentSection() {
    equipmentSectionCounter++;
    const container = document.getElementById('equipment-sections');
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'equipment-section';
    sectionDiv.setAttribute('data-section-id', equipmentSectionCounter);

    sectionDiv.innerHTML = `
      <div class="equipment-section-header" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px;">
        <h4 style="margin: 0;">Equipamento ${equipmentSectionCounter + 1}</h4>
        <button type="button" class="btn danger" onclick="removeEquipmentSection(${equipmentSectionCounter})">Remover</button>
      </div>
      <div class="grid">
        <div class="field">
          <label>Especifica√ß√£o T√©cnica</label>
          <textarea class="tech_spec" rows="4" placeholder="Detalhe t√©cnico do equipamento..."></textarea>
        </div>
        <div class="field">
          <label>Princ√≠pio de Funcionamento</label>
          <textarea class="principle" rows="4" placeholder="Descreva o princ√≠pio de funcionamento..."></textarea>
        </div>
      </div>
      <div class="field">
        <label>Imagem do Equipamento</label>
        <input type="file" class="equipment_image" accept="image/*" />
        <small style="color: #666; font-size: 12px;">Formatos aceitos: JPG, PNG, GIF (m√°x. 5MB)</small>
      </div>
    `;

    container.appendChild(sectionDiv);
    updateRemoveButtons();
  }

  function removeEquipmentSection(sectionId) {
    const section = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (section) {
      section.remove();
      updateRemoveButtons();
      updateSectionNumbers();
    }
  }

  function updateRemoveButtons() {
    const sections = document.querySelectorAll('.equipment-section');
    sections.forEach((section, index) => {
      const removeBtn = section.querySelector('.btn.danger');
      if (removeBtn) {
        removeBtn.style.display = sections.length > 1 ? 'block' : 'none';
      }
    });
  }

  function updateSectionNumbers() {
    const sections = document.querySelectorAll('.equipment-section');
    sections.forEach((section, index) => {
      const header = section.querySelector('h4');
      if (header) {
        header.textContent = `Equipamento ${index + 1}`;
      }
    });
  }

  function addRow(sectionId, preset){
    try {
      console.log('addRow chamado para:', sectionId, preset);
      const section = document.getElementById(sectionId);
      if (!section) {
        console.error('Se√ß√£o n√£o encontrada:', sectionId);
        return;
      }

      const container = section.querySelector('.items');
      if (!container) {
        console.error('Container .items n√£o encontrado na se√ß√£o:', sectionId);
        return;
      }

      const row = document.createElement('div');
      row.className = 'item_row';
      const p = preset || {};
      // Verifica se √© se√ß√£o de servi√ßos para mostrar campo de dias
      const isServiceSection = sectionId.includes('operacionais') || sectionId.includes('assessoria');
      const daysField = isServiceSection ? `<input type="number" class="item_days" min="1" step="1" placeholder="Dias" value="${p.days||1}" title="Quantidade de dias" />` : '';

      row.innerHTML = `
        <input type="text" class="item_name" placeholder="Descri√ß√£o" value="${p.name||''}" />
        <input type="number" class="item_qty" min="1" step="1" value="${p.qty||1}" />
        ${daysField}
        <input type="number" class="item_unit" step="0.01" min="0" placeholder="Pre√ßo unit√°rio" value="${p.unit||p.unit_price||p.price||''}" />
        <select class="item_currency">
          <option value="BRL" ${p.currency==='BRL'?'selected':''}>Real (R$)</option>
          <option value="USD" ${p.currency==='USD'?'selected':''}>D√≥lar ($)</option>
          <option value="EUR" ${p.currency==='EUR'?'selected':''}>Euro (‚Ç¨)</option>
        </select>
        <button type="button" class="btn danger" onclick="this.parentNode.remove()">Remover</button>`;
      container.appendChild(row);
      console.log('Item adicionado com sucesso!');
    } catch (error) {
      console.error('Erro ao adicionar row:', error);
    }
  }

  // Nova fun√ß√£o mais robusta para checkboxes
  function handleServiceToggle(checkbox, sectionId) {
    try {
      console.log('handleServiceToggle:', checkbox.value, 'checked:', checkbox.checked, 'sectionId:', sectionId);

      if (checkbox.checked) {
        // Adiciona item
        addRow(sectionId, {
          name: checkbox.value,
          qty: 1,
          unit: '',
          currency: 'BRL'
        });
      } else {
        // Remove item
        removeItemByName(sectionId, checkbox.value);
      }
    } catch (error) {
      console.error('Erro em handleServiceToggle:', error);
    }
  }

  // Mant√©m fun√ß√£o antiga para compatibilidade
  function quickToggle(cb, sectionId){
    handleServiceToggle(cb, sectionId);
  }

  function removeItemByName(sectionId, itemName) {
    const container = document.getElementById(sectionId).querySelector('.items');
    const rows = container.querySelectorAll('.item_row');
    rows.forEach(row => {
      const nameInput = row.querySelector('.item_name');
      if (nameInput && nameInput.value === itemName) {
        row.remove();
      }
    });
  }

  function validateCurrencies() {
    const usedCurrencies = new Set();

    // Coleta todas as moedas usadas nos itens
    document.querySelectorAll('.item_currency').forEach(select => {
      if (select.value && select.closest('.item_row').querySelector('.item_name').value) {
        usedCurrencies.add(select.value);
      }
    });

    // Verifica se h√° mais de 2 moedas
    if (usedCurrencies.size > 2) {
      const currencies = Array.from(usedCurrencies);
      alert(`Erro: M√°ximo 2 moedas permitidas na cota√ß√£o.\nEncontradas: ${currencies.join(', ')}\nPor favor, use apenas 2 moedas diferentes.`);
      return false;
    }

    return true;
  }

  function collectPayload(){
    // Valida moedas antes de coletar dados
    if (!validateCurrencies()) {
      return false;
    }

    // Coletar dados das se√ß√µes de equipamentos
    const equipmentSections = [];
    document.querySelectorAll('.equipment-section').forEach((section, index) => {
      const techSpec = section.querySelector('.tech_spec')?.value || '';
      const principle = section.querySelector('.principle')?.value || '';
      if (techSpec || principle) {
        equipmentSections.push({
          tech_spec: techSpec,
          principle: principle,
          index: index
        });
      }
    });

    // Combinar especifica√ß√µes de todos os equipamentos
    let combinedTechSpec = '';
    let combinedPrinciple = '';

    equipmentSections.forEach((eq, index) => {
      if (eq.tech_spec) {
        if (equipmentSections.length > 1) {
          combinedTechSpec += `--- EQUIPAMENTO ${index + 1} ---\n\n${eq.tech_spec}\n\n`;
        } else {
          combinedTechSpec = eq.tech_spec;
        }
      }
      if (eq.principle) {
        if (equipmentSections.length > 1) {
          combinedPrinciple += `--- EQUIPAMENTO ${index + 1} ---\n\n${eq.principle}\n\n`;
        } else {
          combinedPrinciple = eq.principle;
        }
      }
    });

    const pack = {
      tech_spec: combinedTechSpec.trim(),
      principle: combinedPrinciple.trim(),
      equipment_sections: equipmentSections,
      sections: {}
    };
    function collect(sectionId){
      const arr = [];
      document.querySelectorAll('#'+sectionId+' .item_row').forEach(row => {
        const name = row.querySelector('.item_name').value;
        const qty = row.querySelector('.item_qty').value;
        const unit = row.querySelector('.item_unit').value;
        const currency = row.querySelector('.item_currency').value;
        const daysInput = row.querySelector('.item_days');
        const days = daysInput ? daysInput.value : null;

        const item = { name, qty, unit, currency };
        if (days) item.days = days;

        if(name){ arr.push(item); }
      });
      return arr;
    }
    // Modalidade A
    pack.sections.itemsEquipA = collect('sec_equip_a');
    pack.sections.itemsAssessoriaA = collect('sec_assessoria_a');
    pack.sections.itemsOperacionaisA = collect('sec_operacionais_a');
    pack.sections.itemsCertificadosA = collect('sec_certificados_a');

    // Modalidade B
    pack.sections.itemsEquipB = collect('sec_equip_b');
    pack.sections.itemsAssessoriaB = collect('sec_assessoria_b');
    pack.sections.itemsOperacionaisB = collect('sec_operacionais_b');
    pack.sections.itemsCertificadosB = collect('sec_certificados_b');
    document.getElementById('specs_json').value = JSON.stringify(pack);
  }

  function submitForm(action){
    document.getElementById('action_field').value = action;
    if (collectPayload() === false) return;
    document.getElementById('quoteForm').submit();
  }

  function previewHtml(){
    if (collectPayload() === false) return;
    const form = document.getElementById('quoteForm');
    const prevAction = form.action;
    const prevTarget = form.target;
    const prevMethod = form.method;

    // Adicionar indicador de status conclu√≠do
    let statusInput = document.getElementById('completed_status');
    if (!statusInput) {
      statusInput = document.createElement('input');
      statusInput.type = 'hidden';
      statusInput.id = 'completed_status';
      statusInput.name = 'status';
      form.appendChild(statusInput);
    }
    statusInput.value = 'Conclu√≠da';

    form.action = '/quotes/save-and-preview';
    form.method = 'post';
    form.target = '_blank';
    form.submit();
    form.action = prevAction;
    form.method = prevMethod;
    form.target = prevTarget;
  }

  function saveQuote(){
    if (collectPayload() === false) return;
    const form = document.getElementById('quoteForm');
    const prevAction = form.action;
    form.action = '/quotes/save';
    form.method = 'post';
    form.target = '';
    form.submit();
  }

  function saveDraft(){
    if (collectPayload() === false) return;
    const form = document.getElementById('quoteForm');
    const prevAction = form.action;
    form.action = '/quotes/save-draft';
    form.method = 'post';
    form.target = '';

    // Adicionar indicador de rascunho
    let statusInput = document.getElementById('draft_status');
    if (!statusInput) {
      statusInput = document.createElement('input');
      statusInput.type = 'hidden';
      statusInput.id = 'draft_status';
      statusInput.name = 'status';
      form.appendChild(statusInput);
    }
    statusInput.value = 'Rascunho';

    form.submit();
  }



  // Fun√ß√£o para copiar Modalidade A para B
  function copyModalidadeAToB(){
    const sections = ['equip', 'assessoria', 'operacionais', 'certificados'];

    sections.forEach(section => {
      const modalidadeAItems = document.querySelectorAll(`#sec_${section}_a .item_row`);
      const modalidadeBContainer = document.getElementById(`sec_${section}_b`).querySelector('.items');

      // Limpar se√ß√£o B primeiro
      modalidadeBContainer.innerHTML = '';

      // Copiar cada item da Modalidade A
      modalidadeAItems.forEach(row => {
        const name = row.querySelector('.item_name').value;
        const qty = row.querySelector('.item_qty').value;
        const unit = row.querySelector('.item_unit').value;
        const currency = row.querySelector('.item_currency').value;

        if(name) {
          addRow(`sec_${section}_b`, { name, qty, unit, currency });
        }
      });
    });

    alert('Modalidade A copiada para Modalidade B com sucesso!');
  }

  // Fun√ß√£o para limpar Modalidade B
  function clearModalidadeB(){
    const sections = ['equip', 'assessoria', 'operacionais', 'certificados'];

    sections.forEach(section => {
      const modalidadeBContainer = document.getElementById(`sec_${section}_b`).querySelector('.items');
      modalidadeBContainer.innerHTML = '';
    });

    alert('Modalidade B limpa com sucesso!');
  }

  // Fun√ß√£o para alternar a visibilidade das condi√ß√µes de pagamento
  function togglePaymentConditions() {
    const checkbox = document.getElementById('include_payment_conditions');
    const fields = document.getElementById('payment_conditions_fields');

    if (checkbox.checked) {
      fields.style.display = 'block';
    } else {
      fields.style.display = 'none';
    }
  }

  // Fun√ß√£o para carregar lista de cota√ß√µes existentes
  async function loadExistingQuotesList() {
    try {
      const response = await fetch('/quotes/list');
      const quotes = await response.json();
      const select = document.getElementById('existing_quotes');

      // Limpar op√ß√µes existentes exceto a primeira
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }

      // Adicionar cota√ß√µes √† lista
      quotes.forEach(quote => {
        const option = document.createElement('option');
        option.value = quote.quote_code;
        option.textContent = `${quote.quote_code} - ${quote.client || quote.company} (${quote.status})`;
        select.appendChild(option);
      });
    } catch (error) {
      console.error('Erro ao carregar lista de cota√ß√µes:', error);
    }
  }

  // Fun√ß√£o para carregar dados de uma cota√ß√£o espec√≠fica
  async function loadExistingQuote() {
    const select = document.getElementById('existing_quotes');
    const quoteCode = select.value;

    if (!quoteCode) {
      alert('Selecione uma cota√ß√£o para carregar.');
      return;
    }

    try {
      const response = await fetch(`/quotes/load/${quoteCode}`);
      const data = await response.json();

      if (!data.success) {
        alert('Erro ao carregar cota√ß√£o: ' + data.error);
        return;
      }

      const quote = data.quote;
      const specs = data.specs || [];

      // Carregar dados b√°sicos
      document.getElementById('quote_code').value = quote.quote_code + '_COPY_' + Date.now();
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      document.getElementById('company').value = quote.company || '';
      document.getElementById('client').value = quote.client || '';
      document.getElementById('cnpj').value = quote.cnpj || '';
      document.getElementById('machine_model').value = quote.machine_model || '';
      document.getElementById('representative').value = quote.representative || '';
      document.getElementById('supplier').value = quote.supplier || '';
      document.getElementById('validity').value = quote.validity_days || 15;
      document.getElementById('delivery').value = quote.delivery_time || '';
      document.getElementById('notes').value = quote.notes || '';

      // Carregar contato
      if (document.getElementById('contact_email')) {
        document.getElementById('contact_email').value = quote.contact_email || '';
      }
      if (document.getElementById('contact_phone')) {
        document.getElementById('contact_phone').value = quote.contact_phone || '';
      }
      if (document.getElementById('seller_name')) {
        document.getElementById('seller_name').value = quote.seller_name || '';
      }

      // Carregar condi√ß√µes de pagamento
      const paymentCheckbox = document.getElementById('include_payment_conditions');
      if (paymentCheckbox && quote.include_payment_conditions) {
        paymentCheckbox.checked = true;
        togglePaymentConditions();

        if (document.getElementById('payment_intro')) {
          document.getElementById('payment_intro').value = quote.payment_intro || '';
        }
        // Carregar outros campos de pagamento se existirem...
      }

      // Carregar especifica√ß√µes t√©cnicas
      if (quote.tech_spec) {
        document.getElementById('tech_spec').value = quote.tech_spec;
      }
      if (quote.principle) {
        document.getElementById('principle').value = quote.principle;
      }

      // Limpar se√ß√µes existentes
      const sections = ['sec_equip_a', 'sec_assessoria_a', 'sec_operacionais_a', 'sec_certificados_a',
                        'sec_equip_b', 'sec_assessoria_b', 'sec_operacionais_b', 'sec_certificados_b'];

      sections.forEach(sectionId => {
        const container = document.getElementById(sectionId)?.querySelector('.items');
        if (container) {
          container.innerHTML = '';
        }
      });

      // Carregar itens das especifica√ß√µes
      specs.forEach(spec => {
        const desc = spec.description?.toUpperCase() || '';
        let targetSection = '';

        if (desc.includes('EQUIPAMENTOS_A')) targetSection = 'sec_equip_a';
        else if (desc.includes('ASSESSORIA_A')) targetSection = 'sec_assessoria_a';
        else if (desc.includes('OPERACIONAIS_A')) targetSection = 'sec_operacionais_a';
        else if (desc.includes('CERTIFICADOS_A')) targetSection = 'sec_certificados_a';
        else if (desc.includes('EQUIPAMENTOS_B')) targetSection = 'sec_equip_b';
        else if (desc.includes('ASSESSORIA_B')) targetSection = 'sec_assessoria_b';
        else if (desc.includes('OPERACIONAIS_B')) targetSection = 'sec_operacionais_b';
        else if (desc.includes('CERTIFICADOS_B')) targetSection = 'sec_certificados_b';

        if (targetSection && spec.items) {
          spec.items.forEach(item => {
            addRow(targetSection, {
              name: item.name,
              qty: item.qty || 1,
              unit: item.price || 0,
              currency: item.currency || 'BRL'
            });
          });
        }
      });

      alert(`Cota√ß√£o "${quoteCode}" carregada com sucesso! C√≥digo atualizado para evitar duplicatas.`);

      // Resetar sele√ß√£o
      select.selectedIndex = 0;

    } catch (error) {
      console.error('Erro ao carregar cota√ß√£o:', error);
      alert('Erro ao carregar cota√ß√£o. Tente novamente.');
    }
  }

  // Carregar lista de cota√ß√µes ao iniciar a p√°gina
  loadExistingQuotesList();

  // Linhas iniciais
  addRow('sec_equip_a');
</script>
<%- include('../partials/bottom') %>
